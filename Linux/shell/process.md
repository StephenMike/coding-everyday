# 进程管理

## ps

`ps`命令用来列出进程信息。

```bash
$ ps
PID TTY           TIME CMD
5198 pts/1    00:00:00 bash
10129 pts/1   00:00:00 ps
```

不带任何参数时，`ps`只列出与当前Session相关的进程。输出结果中，`PID`是进程ID、`TTY`是进程的终端号（如果显示`?`，则表示进程没有终端），`TIME`是消耗的CPU时间，`CMD`是触发进程的命令。

`x`参数列出所有进程的详细信息，包括不在当前Session的信息。

```bash
$ ps x
PID TTY   STAT   TIME COMMAND
2799 ?    Ssl    0:00 /usr/libexec/bonobo-activation-server –ac
2820 ?    Sl     0:01 /usr/libexec/evolution-data-server-1.10 --
```

这时的输出结果，会多出`STAT`一栏，表示状态。它的各种值如下。

- `R` 正在运行或准备运行
- `S` 正在睡眠，即没有运行，正在等待一个事件唤醒
- `D` 不可中断睡眠。进程正在等待 I/O，比如磁盘驱动器的I/O
- `T` 已停止，即进程停止运行
- `Z` “僵尸”进程。即这是一个已经终止的子进程，但父进程还没有清空它（没有把子进程从进程表中删除）
- `<` 高优先级进程。这可能会授予一个进程更多重要的资源，给它更多的 CPU 时间。
- `N` 低优先级进程。一个低优先级进程（一个“好”进程）只有当其它高优先级进程执行之后，才会得到处理器时间。

`aux`参数可以显示更多信息。

```bash
$ ps aux
USER   PID  %CPU  %MEM     VSZ    RSS  TTY   STAT   START   TIME  COMMAND
root     1   0.0   0.0    2136    644  ?     Ss     Mar05   0:31  init
root     2   0.0   0.0       0      0  ?     S&lt;     Mar05   0:00  [kt]
```

输出结果包含的列的含义如下。

- `USER` 用户ID，表示进程的所有者
- `%CPU` 百分比表示的 CPU 使用率
- `%MEM` 百分比表示的内存使用率
- `VSZ` 虚拟内存大小
- `RSS` 进程占用的物理内存的大小，以千字节为单位。
- `START` 进程运行的起始时间。若超过24小时，则用天表示。

## top

`top`命令可以查看机器的当前状态。

```bash
$ top
```

它的输出结果分为两部分，最上面是系统概要，下面是进程列表，以 CPU 的使用率排序。

输出结果是动态更新的，默认每三分钟更新一次。
- P CPU排序
- M 内存排序
- N PID排序
- q 退出top


1. buffers：缓冲， 如写入cpu时，可先缓冲一定的数据
2. caches：缓存，  如读取硬盘数据，可先将数据缓存到内存中

修改进程的优先级   
- 优先级决定了每个进程处理的先后顺序  
- `PRI`代表`Priority`，`NI`，代表`Nice`，两个值都是优先级，数字越小代表该进程优先级越高
- `ni`值范围-20-19   
- 普通用户调整范围是0-19，且只能调整自己的进程，普通用户只能调高ni值，不能降低
- root 用户才能设定进程值为负数，且可以调整任何用户的进程
- `PRI`(最终值）=PRI原始值+NI 用户只能修改NI  不能直接修改PRI
- `nice` 命令   [选项]命令 #nice命令可以给新执行的命令直接赋予NI值，但是不能修改存在的NI值     
  - 选项-n  NI值：给命令赋予NI值

```
nice -n -5 service httpd start
```
- `renice` 命令，#修改已存在的进程的NI值的命令，后面是`PID`  例：`renice -10 2125`   
- 内存优先级修改，作用不大，除非做内核裁剪嵌入式开发，否则修改优先级是没有太大作用的


## jobs

`jobs`命令用来查看后台任务。

```bash
$ jobs
[1]+ Running            xlogo &
```

输出结果之中，每个后台任务会有一个编号。上面结果中，`xlogo`的编号是`1`，`+`表示正在运行。

Linux 后台运行：命令后面加上`“ &”`

windows 最小化就是放入后台执行

#### 工作（后台）管理的注意事项：
1. 当前的登录终端，只能管理当前终端的工作，而不能管理其他登录终端的工作（`mysql`内部做了处理，退出终端， 它也不会退出）
2. 放入后台的命令必须可以持续运行一段时间，这样我们才能捕捉和操作这个工作（比如`ls cd`不用放入后台，一执行就消失了，放入后台没意义）
3. 放入后台执行的命令不能和前台用户有交互或需要前台输入，否则放入后台只能暂停，而不能执行（比如`vi`不行）

具体操作：
1. 把进程放入后台
- `tar -zcf etc.tar.gz /etc &`    #在命令后加个`&`，把命令放在后台执行
- `top`   # `ctrl+z`放在后台暂停

2. 查看后台的工作
```
jobs [-l]
```
- -l:显示工作的PID

 - +代表最后一个放入的进程
- -代表倒二个放入的进程


3. `fg %工作号` #把后台暂停的工作回复到前台执行
4. `bg %工作号` #把后台暂停的工作回复到后台执行
   - 1：%可以省略，但要注意工作号和 PID 的区别
   - 2：后台恢复执行的命令，是不能和前台有交互的，否则不能恢复到后台执行

注意：
- top、vi之类放在后台也是暂停的
   - 因为一个需要用户来查看进程健康状态，一个需要用户写入
- 压缩、解压缩、cp、mv、find之类可以放在后台
- 所以，想要让这个命令在后台运行，首先，不能与用户有交互。其次，它要运行一段时间


#### 后台命令脱离终端执行
1. 简介：把命令放入后台，只能在当前登录终端执行。一旦退出或关闭终端，
后台程序就会停止	
2. 后台命令脱离登录终端执行的方法：
  - 第一种方法 ：把需要后台执行的命令加入 /etc/rc.local文件
  - 第二种方法：使用系统定时任务，让系统在指定的时间执行某个后台命令
  - 第三种方法：使用 nohup命令（常用）
```
nohup  命令  &
```

背景：把命令放入后台执行，只能在当前登录的终端执行，一旦用户退出当前终端
- 后台程序就会停止
- 相当于：后台执行的命令和当前终端绑定了
- 当用户logout时，会向该用户终端下所有进程发送`SIGHUP`信号      
- （守护进程damon进程开机运行，某一个用户退出终端不影响该程序的运行）



## fg

`fg`命令用于将后台任务切换到前台。

```bash
$ fg %1
```

`fg`命令之后，跟随着一个百分号和工作序号，用来指定切换哪一个后台任务。如果只有一个后台任务，那么`fg`命令可以不带参数。

## bg

`bg`命令用于将一个暂停的前台任务，转移到后台。只有暂停的任务，才能使用`bg`命令，因为正在运行的任务，命令行是无法输入的。

```bash
$ bg %1
```

`Ctrl + z`可以暂停正在运行的前台任务。

## kill

`kill`命令用于杀死进程。它的参数是进程ID。

```bash
$ kill 28401
```

`kill`命令的实质是**操作系统向进程发送信号**。在使用 `Ctrl-c` 的情况下，会发送一个叫做 INT（中断）的信号；当使用 `Ctrl-z` 时，则发送一个叫做 TSTP（终端停止）的信号。

`kill`命令可以用来向进程发送指定信号。

```bash
$ kill [-signal] PID
```

下面是常见信号。

- `HUP`：编号1，表示挂起。发送这个信号到前台程序，程序会终止。许多守护进程也使用这个信号，来重新初始化。这意味着，当发送这个信号到一个守护进程后， 这个进程会重新启动，并且重新读取它的配置文件。Apache 网络服务器守护进程就是一个例子。
- `INT`：编号2，中断。实现和`Ctrl-c`一样的功能，由终端发送。通常，它会终止一个程序。
- `KILL`：编号9，杀死。进程可能选择忽略这个信号。所以，操作系统不发送该信号到目标进程，而是内核立即终止这个进程。当一个进程以这种方式终止的时候，它没有机会去做些“清理”工作，或者是保存劳动成果。因为这个原因，把 KILL 信号看作杀手锏，当其它终止信号失败后，再使用它。
- `TERM`：编号15，终止。这是 kill 命令发送的默认信号。如果程序仍然“活着”，可以接受信号，那么这个信号终止。
- `CONT`：编号18，继续。在停止一段时间后，进程恢复运行。
- `STOP`：编号19，停止。这个信号导致进程停止运行，而没有终止。像 KILL 信号，它不被 发送到目标进程，因此它不能被忽略。
- `QUIT`：编号3，退出
- `SEGV`：编号11，段错误。如果一个程序非法使用内存，就会发送这个信号。也就是说，程序试图写入内存，而这个内存空间是不允许此程序写入的。
- `TSTP`：编号20，终端停止。当按下 Ctrl-z 组合键后，终端发送这个信号。不像 STOP 信号， TSTP 信号由目标进程接收，且可能被忽略。
- `WINCH`：编号28，改变窗口大小。当改变窗口大小时，系统会发送这个信号。 一些程序，像 top 和 less 程序会响应这个信号，按照新窗口的尺寸，刷新显示的内容。

`-l`参数可以列出所有信号。

```bash
$ kill -l
```

Kill -9 和 kill-15的区别？
- 9：SIGKILL，强制中断一个进程的进行
- 15：SIGTERM，以正常的结束进程方式来终止进程


## killall

`killall`命令用于向指定的程序或用户发送信号。

```bash
$ killall [-u user] [-signal] name
```

## 其他进程相关命令

- `pstree` 输出树型结构的进程列表，这个列表展示了进程间父/子关系。
- `vmstat` 输出一个系统资源使用快照，包括内存，交换分区和磁盘 I/O。 为了看到连续的显示结果，则在命令名后加上延时的时间（以秒为单位）。例如，“vmstat 5”。 终止输出，按下 Ctrl-c 组合键。
- `xload` 一个图形界面程序，可以画出系统负载的图形。
- `tload` 与`xload`程序相似，但是在终端中画出图形。使用 Ctrl-c，来终止输出。
